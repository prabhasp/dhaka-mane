<!DOCTYPE html>
<meta charset="utf-8">
<body style="background:black">
<div style="position:relative;width:1200px; height: 400px"> 
  <img id="imgleft" src="static/img/dhaka.jpg" width="600" height="400" 
       style="position:absolute; left:0; top:0; visibility: hidden;"></img>
  <img id="imgright" src="static/img/dhaka_tiled.jpg" width="600" height="400" 
       style="position:absolute; right:0; top:0; visibility: hidden;"></img>
  <canvas id="left" style="position:absolute; left: 0; top: 0" width="600" height="400"></canvas>
  <canvas id="right" style="position:absolute; right: 0; top: 0" width="600" height="400"></canvas>
</div>
<script src="static/socket.io.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var canvas1 = d3.select("#left"),
    canvas2 = d3.select("#right"),
    context1 = canvas1.node().getContext("2d"),
    context2 = canvas2.node().getContext("2d"),
    width = canvas1.property("width"),
    height = canvas1.property("height"),
    image = context1.createImageData(width, height),
    imglt = document.getElementById("imgleft"),
    imgrt = document.getElementById("imgright");
  /* BG of image: black */
  for (var i = 0; i < image.data.length; i+= 4) {
      image.data[i + 0] = 0;
      image.data[i + 1] = 0;
      image.data[i + 2] = 0;
      image.data[i + 3] = 255;
  }; 
  context1.putImageData(image, 0, 0);
  context2.putImageData(image, 0, 0);
  imglt.style.visibility = "visible";
  imgrt.style.visibility = "visible";


var worker = new Worker("static/generate-randomized-depth-first-traversal.js");
worker.postMessage({width: width, height: height});
worker.addEventListener("message", function(event) {
  worker.terminate();

  var N = 1 << 0,
      S = 1 << 1,
      W = 1 << 2,
      E = 1 << 3;

  var cells = event.data,
      distance = 0,
      visited = new Array(width * height),
      frontier = [(height - 1) * width];

  function flood() {
    var frontier1 = [],
        i0,
        n0 = frontier.length,
        i1;

    for (var i = 0; i < n0; ++i) {
      i0 = frontier[i] << 2;
      image.data[i0 + 3] = 0;
    }

    for (var i = 0; i < n0; ++i) {
      i0 = frontier[i];
      if (cells[i0] & E && !visited[i1 = i0 + 1]) visited[i1] = true, frontier1.push(i1);
      if (cells[i0] & W && !visited[i1 = i0 - 1]) visited[i1] = true, frontier1.push(i1);
      if (cells[i0] & S && !visited[i1 = i0 + width]) visited[i1] = true, frontier1.push(i1);
      if (cells[i0] & N && !visited[i1 = i0 - width]) visited[i1] = true, frontier1.push(i1);
    }

    frontier = frontier1;
    return !frontier1.length;
  }

  d3.timer(function() {
    for (var i = 0, done; i < 200 && !(done = flood()); ++i);
    context1.putImageData(image, 0, 0);
    context2.putImageData(image, 0, 0);
    if (done) { location.reload(); };
    return done;
  });

});

var socket = io.connect('/cpu');

// Update the graph when we get new data from the server
socket.on('cpu_data', function(data) {
    console.log(data);
});


</script>
</body>
